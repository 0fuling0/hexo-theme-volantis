<script>
  volantis.layoutHelper("comments",`<div id="artalk_container"><i class="fas fa-cog fa-spin fa-fw fa-2x"></i></div>`);
  function load_artalk() {
    if(!document.querySelectorAll("#artalk_container")[0])return;
    volantis.css("<%- theme.comments.artalk.css %>");
    volantis.js("<%- theme.comments.artalk.js %>").then(pjax_artalk);
  }

  function pjax_artalk() {
    if(!document.querySelectorAll("#artalk_container")[0])return;
    let path = pdata.commentPath;
    let placeholder = pdata.commentPlaceholder || "<%= theme.comments.artalk.placeholder %>" || "";
    if (path.length == 0) {
      path = '<%= theme.comments.artalk.path %>' || decodeURI(window.location.pathname);
    }

    volantis.artalk = new Artalk(Object.assign(<%- JSON.stringify(theme.comments.artalk) %>, {
      el: '#artalk_container',
      pageKey: path,
      pageTitle: document.title,
      placeholder: placeholder,
      site: '<%= config.title %>',
      darkMode: volantis.dark.mode === "dark"
    }));

    volantis.artalk.ctx.on('comments-loaded', e => {
      const nodeList = document.querySelectorAll('.atk-content img:not([fancybox]):not([atk-emoticon])');
      nodeList.forEach(item => {
        item.setAttribute('fancybox', 'true');
        const url = item.getAttribute('data-lazy-src') || item.getAttribute('src');
        const alt = item.getAttribute('alt') || '';
        const template = `<a class='fancybox' href='${url}' data-fancybox='Comments' data-caption='${alt}'>${item.outerHTML}</a>`;
        const node = document.createElement('template');
        node.innerHTML = template;
        item.parentNode.replaceChild(node.content.lastChild, item);
      })

      if(nodeList.length !== 0) {
          const checkFancyBox = setInterval(() => {
            if(typeof volantisFancyBox === "undefined") return;
            clearInterval(checkFancyBox);
            if (typeof Fancybox === "undefined") {
              volantisFancyBox.loadFancyBox();
            } else {
              volantisFancyBox.initFancyBox();
            }
          })
        }
    })
  }

  load_artalk();
  volantis.pjax.push(()=>{
    if (typeof Artalk === "undefined") {
      load_artalk();
    } else {
      pjax_artalk();
    }
  },'artalk');

  function dark_artalk() {
    if(!document.querySelectorAll("#artalk_container")[0]) return;
    volantis.artalk.setDarkMode(volantis.dark.mode === "dark")
  }
  volantis.dark.push(dark_artalk);
</script>
